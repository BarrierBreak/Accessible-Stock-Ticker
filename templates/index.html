<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Ticker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .stock-info {
            display: inline-block;
            margin-right: 20px;
        }

        .up-arrow {
            color: green;
        }

        .down-arrow {
            color: red;
        }
        #announceBtn:focus {
            border: 2px solid black;
        }
        #notAnnounceBtn:focus {
            border: 2px solid black;
        }
        #setPoliteBtn:focus {
            border: 2px solid black;
        }
        .container{
            text-align: center;
        }
        #stock-ticker{
            padding: 3%;
        }
        .stock-ticker-list{
            display: inline-flex;
        }
        ul {
            list-style-type: none;
        }
        .logo {
            max-width: 150px;
            height: auto;
        }
    </style>
</head>
<body>

    <div class="container mt-5">
        <img src="logo.png" alt="BarrierBreak">
        <h1>Accessible Stock Ticker</h1>
        <div id="stock-ticker">
            <ul class="stock-ticker-list">
                <li>
                    <div id="nifty-bank" class="stock-info">Nifty-bank: 35000</div>
                </li>
                <li>
                    <div id="sensex" class="stock-info">Sensex: 50000</div>
                </li>
                <li>
                    <div id="nifty-50" class="stock-info">Nifty-50: 15000</div>
                </li>
            </ul>
        </div>
    
        <div class="mt-4">
            <ul class="stock-ticker-list">
                <li>
                    <button id="announceBtn" class="btn btn-primary me-2">
                        Speak
                        <span id="announceText" class="visually-hidden">Selected</span>
                    </button>
                </li>
                <li> 
                    <button id="setPoliteBtn" class="btn btn-info me-2">
                        Speak politely
                        <span id="setPoliteText" class="visually-hidden">Selected</span>
                    </button>
                </li>
                <li>
                    <button id="notAnnounceBtn" class="btn btn-secondary me-2">
                        Don't Speak
                        <span id="notAnnounceText" class="visually-hidden">Selected</span>
                    </button>
                </li>
            </ul>
        </div>
    
        <!-- ARIA live region for screen reader announcements -->
        <div id="announcement" class="mt-3 visually-hidden" aria-hidden="true"></div>
    </div>

<script>
    const niftyBank = document.getElementById('nifty-bank');
    const sensex = document.getElementById('sensex');
    const nifty50 = document.getElementById('nifty-50');
    const announceBtn = document.getElementById('announceBtn');
    const notAnnounceBtn = document.getElementById('notAnnounceBtn');
    const setPoliteBtn = document.getElementById('setPoliteBtn');
    let announce = true; // Flag to track announcement state

    function updateButtonText(button, selected) {
        const hiddenText = button.querySelector('.visually-hidden');
        hiddenText.textContent = selected ? 'Selected' : '';
    }


    let prevNiftyBank, prevSensex, prevNifty50;

    function updateTicker() {
        fetch('/get_data')
            .then(response => response.json())
            .then(data => {
                const currentIndex = Math.floor(Date.now() / 5000) % data.length;
                const currentData = data[currentIndex];

                const arrowNiftyBank = getArrowAndChange(prevNiftyBank, currentData.nifty_bank, 'nifty-bank');
                const arrowSensex = getArrowAndChange(prevSensex, currentData.sensex, 'sensex');
                const arrowNifty50 = getArrowAndChange(prevNifty50, currentData.nifty_50, 'nifty-50');

                if (announce) {
                    announceStockValues(currentData, arrowNiftyBank, arrowSensex, arrowNifty50);
                }

                prevNiftyBank = currentData.nifty_bank;
                prevSensex = currentData.sensex;
                prevNifty50 = currentData.nifty_50;
            });
    }

    function announceStockValues(data, arrowNiftyBank, arrowSensex, arrowNifty50) {
        let announcement = '';
        if (arrowNiftyBank.change === 'Increasing') {
            announcement += ` Nifty Bank ${data.nifty_bank} ${arrowNiftyBank.percentChange}% `;
        } else if (arrowNiftyBank.change === 'Decreasing') {
            announcement += ` Nifty Bank ${data.nifty_bank} ${arrowNiftyBank.percentChange}% `;
        }

        if (arrowSensex.change === 'Increasing') {
            announcement += ` Sensex ${data.sensex} ${arrowSensex.percentChange}% `;
        } else if (arrowSensex.change === 'Decreasing') {
            announcement += ` Sensex ${data.sensex} ${arrowSensex.percentChange}% `;
        }

        if (arrowNifty50.change === 'Increasing') {
            announcement += ` Nifty 50 ${data.nifty_50} ${arrowNifty50.percentChange}% `;
        } else if (arrowNifty50.change === 'Decreasing') {
            announcement += ` Nifty 50 ${data.nifty_50} ${arrowNifty50.percentChange}% `;
        }

        document.getElementById('announcement').textContent = announcement.trim();
    }

    function getArrowAndChange(prevValue, newValue, id) {
        if (prevValue === undefined || newValue === prevValue) {
            return { arrow: '', change: 'No change', percentChange: 0 };
        }

        const percentChange = ((newValue - prevValue) / prevValue * 100).toFixed(2);
        const arrow = newValue > prevValue ? '<span aria-hidden="true" class="up-arrow">&#x25B2;</span>' : '<span aria-hidden="true" class="down-arrow">&#x25BC;</span>';
        const change = newValue > prevValue ? 'Increasing' : 'Decreasing';
        document.getElementById(id).innerHTML = `${id.charAt(0).toUpperCase() + id.slice(1)}: ${newValue} (${arrow} ${percentChange}%)`;

        return { arrow, change, percentChange };
    }

    announceBtn.addEventListener('click', () => {
        announce = true;
        document.getElementById('stock-ticker').setAttribute('aria-live', 'assertive');
        document.getElementById('stock-ticker').setAttribute('aria-atomic', 'true');
        updateButtonText(announceBtn, true);
        updateButtonText(notAnnounceBtn, false);
        updateButtonText(setPoliteBtn, false);
    });

    notAnnounceBtn.addEventListener('click', () => {
        announce = false;
        document.getElementById('stock-ticker').removeAttribute('aria-live', 'polite');
        document.getElementById('stock-ticker').removeAttribute('aria-atomic', 'true');
        updateButtonText(announceBtn, false);
        updateButtonText(notAnnounceBtn, true);
        updateButtonText(setPoliteBtn, false);
    });

    setPoliteBtn.addEventListener('click', () => {
        announce = true;
        document.getElementById('stock-ticker').setAttribute('aria-live', 'polite');
        document.getElementById('stock-ticker').setAttribute('aria-atomic', 'true');
        updateButtonText(announceBtn, false);
        updateButtonText(notAnnounceBtn, false);
        updateButtonText(setPoliteBtn, true);
    });

    window.addEventListener('load', () => {
        document.getElementById('announceText').textContent = '';
        document.getElementById('notAnnounceText').textContent = '';
        document.getElementById('setPoliteText').textContent = '';
    });

    setInterval(updateTicker, 10000); // Update ticker every 5 seconds

    // Initial update
    updateTicker();
</script>

</body>
</html>
